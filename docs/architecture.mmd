flowchart TD
    subgraph Client["Client Layer"]
        UI[Dashboard UI<br/>React + Framer Motion]
        SWR[SWR Cache<br/>5min revalidation]
        Constellation[SourceConstellation<br/>favicon logos · skeleton + refresh modes]
        RefreshWrapper[ConstellationRefreshWrapper<br/>polls refresh-status every 1.5s]
    end

    subgraph ExtConsumers["External Consumers"]
        ThirdParty[Third-party Services<br/>CORS enabled]
    end

    subgraph API["API Layer · Next.js Route Handlers · vercel.json maxDuration"]
        Feed["/api/feed<br/>after · background refresh"]
        RefreshStatus["/api/feed/refresh-status<br/>per-source progress"]
        Discovery["/api/discovery/items<br/>rate limited · search · paginated"]
        V1["/api/v1/discovery/items<br/>versioned alias"]
        Settings["/api/settings"]
        Sources["/api/sources<br/>+ health data"]
        Detect["/api/sources/detect<br/>RSS auto-detection"]
    end

    subgraph Cache["Caching"]
        MemCache[Memory Cache<br/>5min TTL]
        CDNCache[CDN Cache<br/>s-maxage=300]
        DBCache[DB Freshness Check<br/>5–60min per category]
    end

    subgraph Fetching["Shared Fetching Layer"]
        EnsureFresh[ensureSourcesFresh<br/>stale-only refetch + health tracking]
    end

    subgraph Adapters["Source Adapters"]
        RSS[RSS Adapter]
        HN[HackerNews Adapter<br/>chunked · timeout · allSettled]
        Reddit[Reddit Adapter<br/>custom subreddits]
        YT[YouTube Adapter<br/>custom channels]
        GH[GitHub Adapter]
        HF[HuggingFace Adapter]
        Anth[Anthropic Adapter<br/>cheerio DOM parser]
    end

    subgraph Scoring["Scoring Engine"]
        Hot[Hot Mode<br/>50/30/20]
        Rising[Rising Mode<br/>70/20/10]
        Top[Top Mode<br/>engagement]
        Normalize[Cross-Category Normalization<br/>min-max 15–85 · 80/20 blend]
    end

    subgraph External["External Sources"]
        RSSFeeds[30+ RSS Feeds]
        HNAPI[HN Firebase API]
        RedditJSON[Reddit JSON]
        YTAPI[YouTube API v3]
        GHTrending[GitHub Trending]
        HFAPI[HuggingFace API]
        AnthNews[Anthropic /news]
    end

    DB[(Supabase PostgreSQL<br/>FK cascades · pooled)]
    Health[Source Health<br/>settings KV store]

    UI --> SWR
    UI --> Constellation
    SWR --> Feed
    SWR --> Discovery
    RefreshWrapper -->|poll| RefreshStatus
    RefreshWrapper --> Constellation
    UI --> Settings
    UI --> Sources
    UI --> Detect

    ThirdParty -->|CORS| Discovery
    ThirdParty -->|CORS| V1
    V1 -.->|re-export| Discovery

    Feed --> MemCache
    Discovery --> CDNCache
    CDNCache --> MemCache
    MemCache --> DBCache
    DBCache -->|if stale| EnsureFresh
    EnsureFresh -.->|after · waitUntil| Adapters

    RSS --> RSSFeeds
    HN --> HNAPI
    Reddit --> RedditJSON
    YT --> YTAPI
    GH --> GHTrending
    HF --> HFAPI
    Anth --> AnthNews

    EnsureFresh -->|batch upsert| DB
    EnsureFresh -->|record health| Health
    DBCache -->|read cached| DB
    Settings --> DB
    Sources --> DB
    Sources -->|read health| Health
    Health --> DB

    DB --> Scoring
    Hot --> Normalize
    Rising --> Normalize
    Top --> Normalize
    Normalize --> Feed
    Normalize --> Discovery
